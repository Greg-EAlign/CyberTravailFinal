<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Parcours sécurisé - Boutique en ligne (safe)</title>
    <style>
    * { font-family: Arial, sans-serif; box-sizing: border-box; }
    body { margin: 20px; background: #f4f6f9; color: #1f1f1f; }
    h1 { margin-bottom: 10px; }
    section { background: #fff; padding: 20px; margin-top: 20px; border-radius: 6px; border: 1px solid #d0d5dd; box-shadow: 0 2px 6px rgba(31,111,235,0.08); }
    a.button { display: inline-block; margin-top: 12px; margin-right: 12px; padding: 12px 18px; border-radius: 4px; text-decoration: none; color: #fff; background: #1f6feb; }
    a.secondary { background: #6c757d; }
    button { padding: 10px 16px; border: none; border-radius: 4px; color: #fff; background: #6c757d; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 8px; border: 1px solid #d0d5dd; text-align: left; }
    th { background: #eef2f7; }
    #state { margin-top: 20px; }
    </style>
    <script>
    "use strict"
    window.addEventListener("load", () => {
        const stateView = document.getElementById("state")
        const resetBtn = document.getElementById("reset")

        const renderTable = (title, rows, columns) => {
            if (!rows || !rows.length) {
                return `<section><h2>${title}</h2><p>Aucune donnée.</p></section>`
            }
            const header = `<tr>${columns.map(col => `<th>${col.label}</th>`).join("")}</tr>`
            const body = rows.map(row => `<tr>${columns.map(col => `<td>${row[col.key]}</td>`).join("")}</tr>`).join("")
            return `<section><h2>${title}</h2><table>${header}${body}</table></section>`
        }

        const refreshState = () => {
            fetch("/api/state")
                .then(res => res.json())
                .then(({state}) => {
                    if (!state) {
                        stateView.innerHTML = ""
                        return
                    }
                    const users = renderTable("Comptes utilisateurs", state.users, [
                        {key: "id", label: "ID"},
                        {key: "username", label: "Utilisateur"},
                        {key: "role", label: "Rôle"}
                    ])
                    const products = renderTable("Catalogue produit", state.products, [
                        {key: "id", label: "ID"},
                        {key: "name", label: "Produit"},
                        {key: "price", label: "Prix"},
                        {key: "stock", label: "Stock"}
                    ])
                    const orders = renderTable("Commandes", state.orders, [
                        {key: "id", label: "Commande"},
                        {key: "userId", label: "Client"},
                        {key: "productId", label: "Produit"},
                        {key: "quantity", label: "Quantité"},
                        {key: "total", label: "Total (€)"}
                    ])
                    stateView.innerHTML = users + products + orders
                })
        }

        resetBtn.addEventListener("click", () => {
            fetch("/api/reset", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({})
            }).then(() => refreshState())
        })

        refreshState()
    })
    </script>
</head>
<body>
    <h1>Démo d’injection SQL - Parcours sécurisé</h1>
    <p>Suivez le chemin <strong>Connexion → Catalogue → Commandes</strong> pour comparer avec la branche vulnérable.</p>

    <section>
        <h2>Étapes du parcours</h2>
        <ol>
            <li><strong>Connexion</strong> : requête préparée et valeurs liées empêchent les injections.</li>
            <li><strong>Catalogue</strong> : recherches et mises à jour filtrent et contrôlent les types.</li>
            <li><strong>Commandes</strong> : validation stricte des quantités et calcul sur le serveur.</li>
        </ol>
        <div>
            <a class="button" href="login.html">Étape 1 · Connexion</a>
            <a class="button" href="catalog.html">Étape 2 · Catalogue</a>
            <a class="button" href="orders.html">Étape 3 · Commandes</a>
        </div>
        <button id="reset" class="secondary">Réinitialiser la boutique</button>
    </section>

    <div id="state"></div>
</body>
</html>
