<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Étape 2 - Catalogue sécurisé</title>
    <style>
    * { font-family: Arial, sans-serif; box-sizing: border-box; }
    body { margin: 20px; background: #f4f6f9; color: #1f1f1f; }
    section { background: #fff; padding: 20px; margin-top: 20px; border-radius: 6px; border: 1px solid #d0d5dd; box-shadow: 0 2px 6px rgba(31,111,235,0.08); }
    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccd0d9; border-radius: 4px; }
    button { margin-top: 12px; margin-right: 8px; padding: 10px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
    button.primary { background: #1f6feb; }
    button.secondary { background: #6c757d; }
    a.button { display: inline-block; margin-top: 12px; margin-right: 12px; padding: 12px 18px; border-radius: 4px; text-decoration: none; color: #fff; background: #1f6feb; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 8px; border: 1px solid #d0d5dd; text-align: left; }
    th { background: #eef2f7; }
    #log { margin-top: 12px; min-height: 24px; }
    textarea { width: 100%; height: 90px; margin-top: 8px; border: 1px solid #ccd0d9; border-radius: 4px; padding: 8px; }
    </style>
    <script>
    "use strict"
    window.addEventListener("load", () => {
        const searchForm = document.getElementById("searchForm")
        const priceForm = document.getElementById("priceForm")
        const logView = document.getElementById("log")
        const productsTable = document.getElementById("products")
        const resetBtn = document.getElementById("reset")
        const payloadUnion = document.getElementById("payloadUnion")
        const payloadUpdate = document.getElementById("payloadUpdate")

        const renderProducts = products => {
            if (!products || !products.length) {
                productsTable.innerHTML = "<p>Aucune donnée.</p>"
                return
            }
            const header = "<tr><th>ID</th><th>Produit</th><th>Description</th><th>Prix</th><th>Stock</th></tr>"
            const body = products.map(({id, name, description, price, stock}) => `<tr><td>${id}</td><td>${name}</td><td>${description}</td><td>${price}</td><td>${stock}</td></tr>`).join("")
            productsTable.innerHTML = `<table>${header}${body}</table>`
        }

        const refreshState = () => {
            fetch("/api/state")
                .then(res => res.json())
                .then(({state}) => renderProducts(state ? state.products : []))
        }

        const callEndpoint = (endpoint, data) => {
            return fetch(endpoint, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            }).then(res => res.json())
        }

        searchForm.addEventListener("submit", event => {
            event.preventDefault()
            const data = Object.fromEntries(new FormData(searchForm).entries())
            callEndpoint("/api/searchProducts", data).then(({actionResult, error}) => {
                if (error) {
                    logView.textContent = `Erreur: ${error}`
                    logView.style.color = "#d64045"
                } else {
                    logView.textContent = `Résultats: ${JSON.stringify(actionResult)}`
                    logView.style.color = "#1f6feb"
                }
            })
        })

        priceForm.addEventListener("submit", event => {
            event.preventDefault()
            const data = Object.fromEntries(new FormData(priceForm).entries())
            callEndpoint("/api/updatePrice", data).then(({actionResult, error}) => {
                if (error) {
                    logView.textContent = `Erreur: ${error}`
                    logView.style.color = "#d64045"
                } else {
                    logView.textContent = `Prix mis à jour: ${JSON.stringify(actionResult)}`
                    logView.style.color = "#1f6feb"
                    refreshState()
                }
            })
        })

        resetBtn.addEventListener("click", () => {
            fetch("/api/reset", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({})
            }).then(() => {
                logView.textContent = "Base réinitialisée."
                logView.style.color = "#1f6feb"
                refreshState()
            })
        })

        payloadUnion.addEventListener("click", () => {
            searchForm.query.value = "%' UNION SELECT id, username, password, role, role FROM Users--"
        })

        payloadUpdate.addEventListener("click", () => {
            priceForm.productId.value = "1"
            priceForm.newPrice.value = "0; UPDATE Products SET price=0 WHERE 1=1; --"
        })

        refreshState()
    })
    </script>
</head>
<body>
    <h1>Étape 2 · Catalogue sécurisé</h1>
    <p>Les payloads ci-dessous sont neutralisés : clauses préparées et contrôles de types empêchent l’exécution arbitraire.</p>

    <section>
        <h2>Recherche catalogue</h2>
        <form id="searchForm">
            <label>Terme recherché</label>
            <input name="query" placeholder="Cyber">
            <button type="submit" class="primary">searchProducts (safe)</button>
            <button type="button" id="payloadUnion" class="secondary">Tester payload UNION</button>
        </form>
    </section>

    <section>
        <h2>Mise à jour de prix</h2>
        <form id="priceForm">
            <label>ID produit</label>
            <input name="productId" placeholder="1" required>
            <label>Nouveau prix</label>
            <textarea name="newPrice" placeholder="49.9"></textarea>
            <button type="submit" class="primary">updatePrice (safe)</button>
            <button type="button" id="payloadUpdate" class="secondary">Tester payload UPDATE</button>
        </form>
        <div id="log"></div>
    </section>

    <section>
        <h2>Catalogue actuel</h2>
        <div id="products"></div>
    </section>

    <section>
        <h2>Navigation</h2>
        <a class="button" href="login.html">Retour · Connexion</a>
        <a class="button" href="orders.html">Étape suivante · Commandes</a>
        <a class="button" href="index.html">Accueil</a>
        <button id="reset" class="secondary">Réinitialiser la boutique</button>
    </section>
</body>
</html>
