<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Étape 1 - Connexion sécurisée</title>
    <style>
    * { font-family: Arial, sans-serif; box-sizing: border-box; }
    body { margin: 20px; background: #f4f6f9; color: #1f1f1f; }
    section { background: #fff; padding: 20px; margin-top: 20px; border-radius: 6px; border: 1px solid #d0d5dd; box-shadow: 0 2px 6px rgba(31,111,235,0.08); }
    label { display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccd0d9; border-radius: 4px; }
    button { margin-top: 12px; margin-right: 8px; padding: 10px 16px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
    button.primary { background: #1f6feb; }
    button.secondary { background: #6c757d; }
    a.button { display: inline-block; margin-top: 12px; margin-right: 12px; padding: 12px 18px; border-radius: 4px; text-decoration: none; color: #fff; background: #1f6feb; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { padding: 8px; border: 1px solid #d0d5dd; text-align: left; }
    th { background: #eef2f7; }
    #log { margin-top: 12px; min-height: 24px; }
    </style>
    <script>
    "use strict"
    window.addEventListener("load", () => {
        const form = document.getElementById("loginForm")
        const logView = document.getElementById("log")
        const usersTable = document.getElementById("users")
        const resetBtn = document.getElementById("reset")
        const payload = document.getElementById("payloadSample")

        const renderUsers = users => {
            if (!users || !users.length) {
                usersTable.innerHTML = "<p>Aucune donnée.</p>"
                return
            }
            const header = "<tr><th>ID</th><th>Utilisateur</th><th>Rôle</th></tr>"
            const body = users.map(({id, username, role}) => `<tr><td>${id}</td><td>${username}</td><td>${role}</td></tr>`).join("")
            usersTable.innerHTML = `<table>${header}${body}</table>`
        }

        const refreshState = () => {
            fetch("/api/state")
                .then(res => res.json())
                .then(({state}) => {
                    renderUsers(state ? state.users : [])
                })
        }

        form.addEventListener("submit", event => {
            event.preventDefault()
            const data = Object.fromEntries(new FormData(form).entries())
            fetch("/api/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            }).then(res => res.json())
            .then(({actionResult, error}) => {
                if (error) {
                    logView.textContent = `Erreur: ${error}`
                    logView.style.color = "#d64045"
                } else if (!actionResult) {
                    logView.textContent = "Connexion refusée (paramètres invalides ou utilisateur inexistant)."
                    logView.style.color = "#1f6feb"
                } else {
                    logView.textContent = `Connexion réussie: ${actionResult.username} (${actionResult.role})`
                    logView.style.color = "#1f6feb"
                }
            })
        })

        resetBtn.addEventListener("click", () => {
            fetch("/api/reset", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({})
            }).then(() => {
                logView.textContent = "Base réinitialisée."
                logView.style.color = "#1f6feb"
                refreshState()
            })
        })

        payload.addEventListener("click", () => {
            form.username.value = "admin"
            form.password.value = "' OR '1'='1"
        })

        refreshState()
    })
    </script>
</head>
<body>
    <h1>Étape 1 · Connexion sécurisée</h1>
    <p>La requête utilise une instruction préparée. Les valeurs liées neutralisent l’injection « <code>' OR '1'='1</code> ».</p>

    <section>
        <h2>Formulaire de connexion</h2>
        <form id="loginForm">
            <label>Utilisateur</label>
            <input name="username" placeholder="admin" required>
            <label>Mot de passe</label>
            <input name="password" placeholder="mot de passe" required>
            <button type="submit" class="primary">login (safe)</button>
            <button type="button" id="payloadSample" class="secondary">Tester payload injection</button>
        </form>
        <div id="log"></div>
    </section>

    <section>
        <h2>Utilisateurs connus</h2>
        <div id="users"></div>
    </section>

    <section>
        <h2>Navigation</h2>
        <a class="button" href="catalog.html">Étape suivante · Catalogue</a>
        <a class="button" href="index.html">Retour à l’accueil</a>
        <button id="reset" class="secondary">Réinitialiser la boutique</button>
    </section>
</body>
</html>
